<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>BrokeNoMore â€” Add New Expense</title>
    <link rel="stylesheet" href="css/addnew_expense.css">
    <link rel="stylesheet" href="css/header.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/nav.js"></script>
</head>
<body>
    <nav>
        <h1><i class="fa-solid fa-paw"></i> BrokeNoMore</h1>
        <div class="links">
            <a href="dashboard.html">Dashboard</a>
            <a href="your_budget.html">Budget</a>
            <a href="expenses.html">Expenses</a>
            <a href="savings.html">Savings</a>
            <a href="notifications.html">Notifications</a>
            <a href="all_transactions.html">Transactions</a>
            <a href="payment_methods.html">Payments</a>
            <a href="profile.html">Profile</a>
        </div>
    </nav>

    <div class="box">
        <h2>Add New Expense</h2>
        <form id="expenseForm" action="addnew_expense.php" method="post">
            <fieldset>
                <label for="date">Date</label><br>
                <input id="date" type="date" name="date" required><br><br>

                <label for="categoryDropdown">Category</label><br>
                <!-- name must be category_id (UUID) -->
                <select name="category_id" id="categoryDropdown" required>
                    <option value="">-- Select a category --</option>
                </select><br><br>

                <label for="amount">Amount</label><br>
                <input id="amount" type="number" name="amount" placeholder="e.g. 500" step="0.01" required><br><br>

                <label for="description">Description</label><br>
                <input id="description" type="text" name="description" placeholder="e.g. Pizza" required><br><br>

                <button id="saveBtn" type="submit" class="save-btn">Save</button>
            </fieldset>
        </form>
    </div>

<script>
/*
  This script:
  - loads categories for the selected date (calls get_categories.php?date=YYYY-MM-DD)
  - populates the dropdown with {category_id, category_name}
  - disables submit if no categories found
*/

const categoryDropdown = document.getElementById('categoryDropdown');
const dateInput = document.getElementById('date');
const saveBtn = document.getElementById('saveBtn');
const expenseForm = document.getElementById('expenseForm');

// Helper to fetch categories for a given date (falls back to today if backend ignores date)
async function loadCategories(dateStr) {
    categoryDropdown.innerHTML = '<option value="">Loading...</option>';
    saveBtn.disabled = true;

    // ask backend for categories for that date (backend may accept ?date= or fall back to today)
    const url = 'get_categories.php' + (dateStr ? '?date=' + encodeURIComponent(dateStr) : '');
    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Network response was not ok');
        const categories = await res.json();

        categoryDropdown.innerHTML = '<option value="">-- Select a category --</option>';

        if (!Array.isArray(categories) || categories.length === 0) {
            categoryDropdown.innerHTML = '<option value="">No active categories for selected date</option>';
            categoryDropdown.disabled = true;
            saveBtn.disabled = true;
            return;
        }

        categories.forEach(cat => {
            // cat is expected to be { category_id, category_name }
            const opt = document.createElement('option');
            opt.value = cat.category_id;
            opt.textContent = cat.category_name;
            categoryDropdown.appendChild(opt);
        });

        categoryDropdown.disabled = false;
        saveBtn.disabled = false;

    } catch (err) {
        console.error('Failed to load categories:', err);
        categoryDropdown.innerHTML = '<option value="">Failed to load categories</option>';
        categoryDropdown.disabled = true;
        saveBtn.disabled = true;
    }
}

// Load categories for today's date on page load
document.addEventListener('DOMContentLoaded', () => {
    // default date = today
    const today = new Date().toISOString().slice(0,10);
    dateInput.value = today;
    loadCategories(today);
});

// Refresh categories when date changes (so category list matches budget covering that date)
dateInput.addEventListener('change', (e) => {
    const dateStr = e.target.value;
    if (dateStr) loadCategories(dateStr);
});

// Final front-end validation before submit (optional extra check)
expenseForm.addEventListener('submit', (e) => {
    const categoryVal = categoryDropdown.value;
    const amount = parseFloat(document.getElementById('amount').value || 0);

    if (!categoryVal) {
        alert('Please select a category.');
        e.preventDefault();
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        alert('Enter a valid amount.');
        e.preventDefault();
        return;
    }

    // let the form submit to addnew_expense.php which will perform final server-side checks
});
</script>

</body>
</html>